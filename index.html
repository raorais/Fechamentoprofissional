<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="author" content="Raphael Morais">
  <title>Sistema de Fechamento</title>
  
  <!-- Ícones e Fonte -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --primary: #00b4d8;
      --primary-dark: #0095c7ab;
      --secondary: #312f2f;
      --dark: #924848;
      --light: #000000;
      --gray: #000000d2;
      --success: #2ecc71;
      --danger: #e74c3c;
      --employee: #9b59b6;
      --card-bg: #ffffff;
      --input-bg: #ffffff;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, var(--dark), var(--secondary));
      color: var(--light);
      min-height: 100vh;
      padding: 20px;
    }

    /* Login */
    .login-container {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .login-card {
      background: var(--card-bg);
      padding: 40px;
      border-radius: 16px;
      width: 100%;
      max-width: 420px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.3);
      border: 1px solid rgba(90, 90, 90, 0.1);
    }

    .login-header {
      text-align: center;
      margin-bottom: 30px;
    }

    .login-logo {
      font-size: 2.5rem;
      color: var(--primary-dark);
      margin-bottom: 10px;
    }

    .login-header h1 {
      font-size: 1.8rem;
      color: var(--gray);
      text-transform: uppercase;
      margin-bottom: 5px;
    }

    /* Sistema Principal */
    #mainSystem {
      display: none;
      max-width: 1200px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      margin-bottom: 30px;
    }

    .logo {
      font-size: 2.5rem;
      color: var(--primary);
      margin-bottom: 10px;
    }

    header h1 {
      font-size: 1.8rem;
      color: var(--primary);
      text-transform: uppercase;
    }

    /* Componentes */
    .panel {
      background: var(--card-bg);
      padding: 30px;
      border-radius: 16px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.3);
      margin-bottom: 30px;
      border: 1px solid rgba(0, 0, 0, 0.1);
    }

    .panel h2 {
      color: var(--gray);
      margin-bottom: 25px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--gray);
      font-size: 0.9rem;
    }

    input, select {
      width: 100%;
      padding: 12px 15px;
      border-radius: 8px;
      border: 1px solid rgba(0, 0, 0, 0.356);
      background: var(--card-bg);
      color: var(--gray);
      font-size: 1rem;
      outline: none;
      transition: border 0.2s;
    }

    input:focus, select:focus {
      border-color: var(--gray);
    }

    /* Botões */
    .buttons {
      display: flex;
      gap: 15px;
      margin-top: 25px;
    }

    button {
      padding: 14px 25px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: all 0.3s;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-success:hover {
      background: #27ae60;
      transform: translateY(-2px);
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn-danger:hover {
      background: #c0392b;
      transform: translateY(-2px);
    }

    .btn-small {
      padding: 8px 15px;
      font-size: 0.9rem;
    }

    /* Tabela */
    table {
      width: 100%;
      border-collapse: collapse;
    }

    th {
      background: rgba(0,0,0,0.3);
      padding: 15px;
      text-align: left;
      border-bottom: 2px solid var(--primary);
      color: var(--primary);
    }

    td {
      padding: 12px 15px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    }

    tr:hover {
      background: rgba(255,255,255,0.05);
    }

    /* Itens */
    .items-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .items-header h3 {
      color: var(--primary);
    }

    .item-row {
      display: grid;
      grid-template-columns: 80px 1fr 150px 150px 80px;
      gap: 15px;
      margin-bottom: 15px;
      align-items: center;
    }

    .item-row.header {
      font-weight: bold;
      color: var(--primary);
    }

    .items-total {
      text-align: right;
      font-size: 1.2rem;
      font-weight: bold;
      color: var(--primary);
      margin-top: 20px;
      padding-top: 20px;
      border-top: 2px solid rgba(0, 0, 0, 0.1);
    }

    /* Badges */
    .badge {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.75rem;
      display: inline-block;
    }

    .badge.funcionario {
      background: rgba(155,89,182,0.2);
      color: var(--employee);
    }

    .badge.pj-presumido {
      background: rgba(255,193,7,0.2);
      color: #ffc107;
    }

    /* Resultados */
    .professional-info {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      padding: 20px;
      background: rgba(0,0,0,0.2);
      border-radius: 10px;
      margin-bottom: 20px;
    }

    .info-label {
      font-weight: 600;
      color: var(--primary);
    }

    .result-item {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px dashed rgba(255,255,255,0.05);
    }

    .result-item.total {
      font-weight: 700;
      font-size: 1.2rem;
      color: var(--gray);
      border-top: 2px solid var(--gray);
      margin-top: 10px;
      padding-top: 15px;
    }

    .empty-state {
      text-align: center;
      padding: 40px;
      color: var(--gray);
    }

    .empty-state i {
      font-size: 3rem;
      margin-bottom: 20px;
      opacity: 0.3;
    }

    footer {
      text-align: center;
      margin-top: 50px;
      padding: 20px;
      color: var(--gray);
      border-top: 1px solid rgba(0, 0, 0, 0.1);
    }

    /* Estilos do recibo (mantidos iguais ao original) */
    .recibo-preview{
      background: white;
      color: black;
      padding: 0;
      margin: 20px auto;
      box-shadow: 0 0 15px rgba(0,0,0,0.2);
      max-width: 210mm;
    }
    .recibo{
      font-family: Arial, Helvetica, sans-serif;
      color: #000;
    }
    .titulo{
      text-align: center;
      font-size: 26pt;
      font-weight: 400;
      margin: 0;
      padding: 0;
    }
    .linha{
      border: none;
      border-top: 1px solid #000;
      margin: 6mm 0 8mm 0;
    }
    .grid2{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8mm;
      font-size: 10pt;
      line-height: 1.4;
    }
    .direita{ text-align: right; }
    .label-negrito{ font-weight: 700; }
    .spacer-6{ height: 6mm; }
    .spacer-8{ height: 8mm; }
    table.recibo-tabela{
      width: 100%;
      border-collapse: collapse;
      font-size: 10pt;
    }
    table.recibo-tabela th,
    table.recibo-tabela td{
      border: 1px solid #000;
      padding: 3mm;
      vertical-align: middle;
    }
    table.recibo-tabela th{
      text-align: center;
      font-weight: 700;
    }
    table.recibo-tabela col.qtd{ width: 10%; }
    table.recibo-tabela col.item{ width: 55%; }
    table.recibo-tabela col.valor{ width: 15%; }
    table.recibo-tabela col.valorPago{ width: 20%; }
    .col-qtd{ text-align: center; }
    .col-valor, .col-valorpago{ text-align: right; }
    .valor-pago-destaque{ font-weight: 700; }
    .pago-a{
      font-size: 10pt;
      line-height: 1.5;
    }
    @media print{
      @page{
        size: A4 portrait;
        margin: 0mm 9mm 0mm 5.5mm;
      }
      html, body{
        width: 210mm;
        height: 297mm;
        margin: 0 !important;
        padding: 0 !important;
        background: #fff !important;
      }
      .recibo-preview{
        box-shadow: none !important;
        margin: 0 !important;
        max-width: none !important;
      }
      .recibo{
        width: 100%;
        color: #000 !important;
        font-family: Arial, Helvetica, sans-serif !important;
      }
      .no-print{ display: none !important; }
    }

    /* Estilo para a lista de resultados da busca */
    .search-results {
      margin-top: 10px;
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid rgba(0,0,0,0.1);
      border-radius: 8px;
      background: white;
    }
    .search-result-item {
      padding: 10px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }
    .search-result-item:hover {
      background-color: #f0f0f0;
    }
  </style>
</head>
<body>
  <!-- Login -->
  <div id="loginPage" class="login-container">
    <div class="login-card">
      <div class="login-header">
        <div class="login-logo">
          <i class="fas fa-calculator"></i>
        </div>
        <h1>Sistema de Fechamento</h1>
        <p style="color: var(--gray);">Acesso ao sistema</p>
      </div>
      
      <div class="form-group">
        <label>Usuário</label>
        <select id="loginUsername">
          <option value="">Selecione um usuário...</option>
          <option value="Giovanna Pereira De Albuquerque Silva">Giovanna</option>
          <option value="Natiely Palmito Dos Santos Gomes">Natiely</option>
          <option value="Luiza Rebeca Ribeiro de Oliveira">Luiza</option>
          <option value="Kauany da Silva Dias">Kauany</option>
          <option value="Gustavo Brambila Acosta Chaves">Gustavo</option>
        </select>
      </div>
      
      <button class="btn-primary" onclick="login()" style="width: 100%;">
        <i class="fas fa-sign-in-alt"></i> Entrar
      </button>
    </div>
  </div>

  <!-- Sistema Principal -->
  <div id="mainSystem">
    <header>
      <div class="logo">
        <i class="fas fa-calculator"></i>
      </div>
      <h1>Sistema de Fechamento</h1>
      <p class="subtitle" id="userGreeting"></p>
    </header>

    <!-- Cadastro -->
    <div class="panel">
      <h2><i class="fas fa-user-plus"></i> Cadastrar</h2>
      
      <!-- Campo de busca -->
      <div class="form-group">
        <label>Buscar profissional (digite o nome)</label>
        <input type="text" id="buscaProfissional" placeholder="Digite para buscar..." onkeyup="filtrarProfissionaisBase()">
        <div id="resultadosBusca" class="search-results" style="display: none;"></div>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label>Nome Completo *</label>
          <input type="text" id="profNome" placeholder="Nome será preenchido automaticamente" readonly>
        </div>
        
        <div class="form-group">
          <label>CPF/CNPJ *</label>
          <input type="text" id="profCpf" placeholder="CPF/CNPJ será preenchido" readonly>
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label>Tipo * (selecione)</label>
          <select id="profRegime">
            <option value="">Selecione...</option>
            <option value="funcionario">Funcionário</option>
            <option value="pj-presumido">PJ - Lucro Presumido</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>Categoria *</label>
          <select id="profCategoria">
            <option value="">Selecione...</option>
            <option value="repasse">Repasses</option>
            <!-- Outras categorias podem ser adicionadas -->
          </select>
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label>Chave PIX</label>
          <input type="text" id="profChavePix" placeholder="Opcional">
        </div>
      </div>
      
      <div class="buttons">
        <button class="btn-success" onclick="cadastrar()">
          <i class="fas fa-save"></i> Cadastrar
        </button>
      </div>
    </div>

    <!-- Lista -->
    <div class="panel">
      <h2><i class="fas fa-list"></i> Cadastros</h2>
      <div id="listaProfissionais"></div>
      <div id="semProfissionais" class="empty-state">
        <i class="fas fa-users"></i>
        <p>Nenhum cadastro encontrado</p>
      </div>
    </div>

    <!-- Cálculo -->
    <div class="panel">
      <h2><i class="fas fa-calculator"></i> Cálculo</h2>
      
      <div class="form-row">
        <div class="form-group">
          <label>Selecionar *</label>
          <select id="selectProfissional">
            <option value="">Selecione...</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>Pagamento</label>
          <select id="formaPagamento">
            <option value="pix">PIX</option>
            <option value="dinheiro">Dinheiro</option>
            <option value="transferencia">Transferência</option>
          </select>
        </div>
      </div>
      
      <div class="items-header">
        <h3>Itens</h3>
        <button class="btn-primary btn-small" onclick="adicionarItem()">
          <i class="fas fa-plus"></i> Adicionar
        </button>
      </div>
      
      <div class="items-table">
        <div class="item-row header">
          <div>Qtd</div>
          <div>Descrição</div>
          <div>Unitário</div>
          <div>Total</div>
          <div></div>
        </div>
        <div id="itensContainer"></div>
      </div>
      
      <div class="items-total" id="totalItens">
        Subtotal: R$ 0,00
      </div>
      
      <div class="buttons">
        <button class="btn-primary" onclick="calcular()">
          <i class="fas fa-calculator"></i> Calcular
        </button>
        <button class="btn-danger" onclick="limparCalculo()">
          <i class="fas fa-broom"></i> Limpar
        </button>
      </div>
    </div>

    <!-- Resultado -->
    <div class="panel">
      <h2><i class="fas fa-chart-bar"></i> Resultado</h2>
      
      <div id="resultado" style="display: none;">
        <div class="professional-info">
          <div><span class="info-label">Nome:</span> <span id="infoNome">-</span></div>
          <div><span class="info-label">Documento:</span> <span id="infoCpf">-</span></div>
          <div><span class="info-label">Tipo:</span> <span id="infoTipo">-</span></div>
          <div><span class="info-label">Data:</span> <span id="infoData">-</span></div>
        </div>
        
        <div class="result-item">
          <span>Subtotal:</span>
          <span id="valorSubtotal">R$ 0,00</span>
        </div>
        
        <div id="impostosContainer" style="display: none;">
          <div class="result-item"><span>PIS (0,65%):</span> <span id="pis">R$ 0,00</span></div>
          <div class="result-item"><span>CSLL (1,0%):</span> <span id="csll">R$ 0,00</span></div>
          <div class="result-item"><span>COFINS (3,0%):</span> <span id="cofins">R$ 0,00</span></div>
          <div class="result-item" id="irrfItem" style="display: none;">
            <span>IRRF (1,5%):</span> <span id="irrf">R$ 0,00</span>
          </div>
        </div>
        
        <div class="result-item total">
          <span>VALOR LÍQUIDO:</span>
          <span id="liquido">R$ 0,00</span>
        </div>
        
        <div class="buttons">
          <button class="btn-success" onclick="gerarRecibo()">
            <i class="fas fa-receipt"></i> Gerar Recibo
          </button>
        </div>
      </div>
      
      <div id="semResultado" class="empty-state">
        <i class="fas fa-calculator"></i>
      </div>
    </div>

    <footer>
      <p>© 2026 Desenvolvido por Raphael Morais</p>
    </footer>
  </div>

  <script>
    // ==================== BASE DE PROFISSIONAIS PRÉ-CADASTRADOS ====================
    const baseProfissionais = [
      { nome: "Francisco Sánchez Montaño", documento: "238.526.928-73", categoria: "repasse" },
      { nome: "Sérgio Alejandro de La Zerda Gutierrez", documento: "231.537.798-64", categoria: "repasse" },
      { nome: "Felipe Rocha Codarin", documento: "369.885.038-97", categoria: "repasse" },
      { nome: "Gustavo Gasparetto Bittar", documento: "093.451.076-81", categoria: "repasse" },
      { nome: "Tacianne Gusman Cavichini", documento: "042.022.557-98", categoria: "repasse" },
      { nome: "Vera Lucia Ribeiro Cinalli", documento: "102.945.688-75", categoria: "repasse" },
      { nome: "Roberta Valadão Negri", documento: "073.675.786-42", categoria: "repasse" },
      { nome: "Breno Gomes Cavalcanti", documento: "049.645.094-86", categoria: "repasse" },
      { nome: "André de Freitas", documento: "178.327.678-98", categoria: "repasse" },
      { nome: "Marcos Antonio Machado", documento: "323.378.938-63", categoria: "repasse" },
      { nome: "Antonio Carlos Medeiros Filho", documento: "088.867.763-49", categoria: "repasse" },
      { nome: "Holter Dr Sèrgio", documento: "237.892.608-19", categoria: "repasse" },
      { nome: "Andre Piacentini Medeiros De Souza Brito", documento: "347.547.988-56", categoria: "repasse" },
      { nome: "Ronaldo Borkowski", documento: "220.164.778-06", categoria: "repasse" },
      { nome: "Maria Aparecida Ferreira da Silva Gonzaga", documento: "118.194.748-01", categoria: "repasse" },
      { nome: "Danilo Costa e Carvalho Pinto", documento: "370.670.248-70", categoria: "repasse" },
      { nome: "Vanessa Yumi Sakamoto", documento: "783.536.102-72", categoria: "repasse" },
      { nome: "Priscila Rosa Da Silva", documento: "386.543.278-63", categoria: "repasse" },
      { nome: "Aline Santos de Almeida", documento: "037.485.593-56", categoria: "repasse" },
      { nome: "Teste Ergometrico", documento: "074.619.301-76", categoria: "repasse" },
      { nome: "Wilson Takeo Sakamoto", documento: "657.667.762-68", categoria: "repasse" },
      { nome: "Teófilo Martín Rondon Aguirre", documento: "216.854.548-01", categoria: "repasse" },
      { nome: "Yuledis Legra Legra", documento: "706.092.792-11", categoria: "repasse" },
      { nome: "Ruben Horacio Igarzabal", documento: "228.827.728-90", categoria: "repasse" },
      { nome: "Silvia Regina Motta Da Prato", documento: "032.360.508-70", categoria: "repasse" },
      { nome: "Carlos Alexandre De Souza Rocha", documento: "676.194.522-49", categoria: "repasse" },
      { nome: "Fabiano Hiromichi Makimoto", documento: "526.432.042-04", categoria: "repasse" },
      { nome: "Fabio Guimaraes Hourneaux de Moura", documento: "880.908.258-34", categoria: "repasse" },
      { nome: "Álvaro Humberto Garcia Sanchez", documento: "703.120.682-04", categoria: "repasse" },
      { nome: "Griselda Natalia Rojas Gutierrez", documento: "238.528.048-50", categoria: "repasse" },
      { nome: "Vinicius De Alencar Da Rocha", documento: "357.202.358-09", categoria: "repasse" },
      { nome: "Luis Fernando Massoni Garcia", documento: "360.470.048-57", categoria: "repasse" },
      { nome: "Glauco Chiaradia Ferreira", documento: "139.117.848-30", categoria: "repasse" },
      { nome: "Lucimar Miguel Da Silva", documento: "029.509.984-45", categoria: "repasse" },
      { nome: "Ansára Alcantara Durante", documento: "407.404.998-82", categoria: "repasse" },
      { nome: "Cinthya Dos Santos Pestana Brito", documento: "333.202.758-10", categoria: "repasse" },
      { nome: "Leticia Sucell Mantilla Osorio", documento: "067.905.911-33", categoria: "repasse" },
      { nome: "Grasiela Passuello", documento: "348.486.468-04", categoria: "repasse" },
      { nome: "Juan Ignacio Espinoza Morales", documento: "214.473.468-23", categoria: "repasse" },
      { nome: "Luiz Fernando Silveira Fahed", documento: "230.410.641-20", categoria: "repasse" },
      { nome: "Diovani Costa Madeira", documento: "099.440.316-07", categoria: "repasse" },
      { nome: "Felipe Zatyrko Morgensztern", documento: "344.465.238-05", categoria: "repasse" },
      { nome: "Thales Teixeira De Noroes", documento: "019.872.933-20", categoria: "repasse" },
      { nome: "Dr. Sergio Mapa", documento: "343.462.918-13", categoria: "repasse" },
      { nome: "Linda Luciana Oliveira Santana", documento: "779.556.682-00", categoria: "repasse" },
      { nome: "André Yuzo Eguchi", documento: "166.934.618-83", categoria: "repasse" },
      { nome: "Breno Bauab", documento: "418.595.848-02", categoria: "repasse" },
      { nome: "Lais Aparecida Saderio Galaverna", documento: "393.510.088-43", categoria: "repasse" },
      { nome: "Camila Mayumi Hammoud Mukai", documento: "418.926.998-00", categoria: "repasse" },
      { nome: "Caroline Barreto Nascimento de Jesus", documento: "421.825.258-07", categoria: "repasse" },
      { nome: "Juliano Cezar Silva Mota", documento: "332.228.678-95", categoria: "repasse" },
      { nome: "Camila Santos Souza", documento: "388.893.278-55", categoria: "repasse" },
      { nome: "Wania Eliza de Almeida", documento: "085.412.606-66", categoria: "repasse" },
      { nome: "Laís Poubel de Medeiros Moura", documento: "127.742.736-41", categoria: "repasse" },
      { nome: "Fernando Castrillon Lara Veiga", documento: "898.885.291-53", categoria: "repasse" },
      { nome: "Vinicius Rodrigo Da Silva Oliveira", documento: "366.753.948-78", categoria: "repasse" },
      { nome: "Saily Hinojosa Zayas", documento: "067.547.281-40", categoria: "repasse" },
      { nome: "Caridad Vega Pupo", documento: "065.537.031-59", categoria: "repasse" }
    ];

    // ==================== DADOS DO SISTEMA ====================
    let profissionais = JSON.parse(localStorage.getItem('profissionais'));
    if (!profissionais) {
      profissionais = []; // começa vazio, o usuário cadastra a partir da base
      localStorage.setItem('profissionais', JSON.stringify(profissionais));
    }

    let itens = [];
    let dadosCalculo = null;
    let usuario = null;

    // ==================== FUNÇÕES DE LOGIN ====================
    function login() {
      const user = document.getElementById('loginUsername').value;
      if (!user) {
        alert('Selecione um usuário');
        return;
      }
      usuario = user;
      document.getElementById('userGreeting').textContent = `Olá, ${user}`;
      document.getElementById('loginPage').style.display = 'none';
      document.getElementById('mainSystem').style.display = 'block';
      atualizarListas();
      adicionarItem();
    }

    document.getElementById('loginPassword')?.addEventListener('keypress', e => {
      if (e.key === 'Enter') login();
    });

    // ==================== FUNÇÕES DE BUSCA ====================
    function filtrarProfissionaisBase() {
      const termo = document.getElementById('buscaProfissional').value.toLowerCase().trim();
      const resultadosDiv = document.getElementById('resultadosBusca');
      
      if (termo.length < 2) {
        resultadosDiv.style.display = 'none';
        return;
      }

      const filtrados = baseProfissionais.filter(p => 
        p.nome.toLowerCase().includes(termo)
      );

      if (filtrados.length === 0) {
        resultadosDiv.style.display = 'none';
        return;
      }

      let html = '';
      filtrados.forEach(p => {
        html += `<div class="search-result-item" onclick="selecionarProfissionalBase('${p.nome}', '${p.documento}', '${p.categoria}')">
          ${p.nome} - ${p.documento}
        </div>`;
      });
      resultadosDiv.innerHTML = html;
      resultadosDiv.style.display = 'block';
    }

    function selecionarProfissionalBase(nome, documento, categoria) {
      document.getElementById('profNome').value = nome;
      document.getElementById('profCpf').value = documento;
      document.getElementById('profCategoria').value = categoria;
      document.getElementById('buscaProfissional').value = ''; // limpa busca
      document.getElementById('resultadosBusca').style.display = 'none';
    }

    // ==================== FUNÇÕES DE CADASTRO ====================
    function cadastrar() {
      const nome = document.getElementById('profNome').value;
      const doc = document.getElementById('profCpf').value;
      const regime = document.getElementById('profRegime').value;
      const categoria = document.getElementById('profCategoria').value;
      
      if (!nome || !doc || !regime || !categoria) {
        alert('Preencha todos os campos obrigatórios (nome, CPF, tipo e categoria)');
        return;
      }
      
      if (profissionais.some(p => p.documento === doc)) {
        alert('Documento já cadastrado');
        return;
      }
      
      profissionais.push({
        id: Date.now(),
        nome, documento: doc, regime, categoria,
        chavePix: document.getElementById('profChavePix').value
      });
      
      localStorage.setItem('profissionais', JSON.stringify(profissionais));
      atualizarListas();
      
      // Limpar formulário
      document.getElementById('profNome').value = '';
      document.getElementById('profCpf').value = '';
      document.getElementById('profRegime').value = '';
      document.getElementById('profCategoria').value = '';
      document.getElementById('profChavePix').value = '';
      
      alert('Cadastro realizado!');
    }

    function atualizarListas() {
      const lista = document.getElementById('listaProfissionais');
      const select = document.getElementById('selectProfissional');
      
      if (profissionais.length === 0) {
        document.getElementById('semProfissionais').style.display = 'block';
        lista.innerHTML = '';
        select.innerHTML = '<option value="">Selecione...</option>';
        return;
      }
      
      document.getElementById('semProfissionais').style.display = 'none';
      
      let html = '<table><tr><th>Nome</th><th>Tipo</th><th>Ação</th></tr>';
      let options = '<option value="">Selecione...</option>';
      
      profissionais.forEach(p => {
        const tipo = p.regime === 'funcionario' ? 'Funcionário' : 'PJ';
        html += `<tr>
          <td>${p.nome}</td>
          <td><span class="badge ${p.regime}">${tipo}</span></td>
          <td><button class="btn-danger btn-small" onclick="excluir(${p.id})"><i class="fas fa-trash"></i></button></td>
        </tr>`;
        options += `<option value="${p.id}">${p.nome} (${tipo})</option>`;
      });
      
      html += '</table>';
      lista.innerHTML = html;
      select.innerHTML = options;
    }

    function excluir(id) {
      if (confirm('Excluir cadastro?')) {
        profissionais = profissionais.filter(p => p.id !== id);
        localStorage.setItem('profissionais', JSON.stringify(profissionais));
        atualizarListas();
      }
    }

    // ==================== FUNÇÕES DE ITENS ====================
    function adicionarItem() {
      itens.push({ id: Date.now(), qtd: 1, descricao: '', valorUnitario: 0, valorTotal: 0 });
      renderizarItens();
    }

    function removerItem(id) {
      itens = itens.filter(i => i.id !== id);
      renderizarItens();
    }

    function atualizarItem(id, campo, valor) {
      const item = itens.find(i => i.id === id);
      if (!item) return;
      
      if (campo === 'qtd') item.qtd = parseInt(valor) || 1;
      if (campo === 'descricao') item.descricao = valor;
      if (campo === 'valorUnitario') item.valorUnitario = parseFloat(valor) || 0;
      
      item.valorTotal = item.qtd * item.valorUnitario;
      renderizarItens();
    }

    function renderizarItens() {
      const container = document.getElementById('itensContainer');
      let html = '';
      let total = 0;
      
      itens.forEach(i => {
        total += i.valorTotal;
        html += `
          <div class="item-row">
            <input type="number" value="${i.qtd}" min="1" onchange="atualizarItem(${i.id}, 'qtd', this.value)">
            <input type="text" value="${i.descricao}" placeholder="Descrição" onchange="atualizarItem(${i.id}, 'descricao', this.value)">
            <input type="number" value="${i.valorUnitario}" step="0.01" min="0" onchange="atualizarItem(${i.id}, 'valorUnitario', this.value)">
            <div>R$ ${i.valorTotal.toFixed(2)}</div>
            <div><button class="btn-danger btn-small" onclick="removerItem(${i.id})"><i class="fas fa-trash"></i></button></div>
          </div>
        `;
      });
      
      container.innerHTML = html;
      document.getElementById('totalItens').innerHTML = `Subtotal: R$ ${total.toFixed(2)}`;
    }

    // ==================== FUNÇÕES DE CÁLCULO ====================
    function calcular() {
      const idProfissional = parseInt(document.getElementById('selectProfissional').value);
      const profissional = profissionais.find(p => p.id === idProfissional);
      
      if (!profissional) {
        alert('Selecione um profissional');
        return;
      }
      
      const subtotal = itens.reduce((s, i) => s + i.valorTotal, 0);
      if (subtotal <= 0) {
        alert('Adicione itens com valor positivo');
        return;
      }
      
      let pis = 0, csll = 0, irrf = 0, cofins = 0;
      
      if (profissional.regime === 'pj-presumido') {
        pis = subtotal * 0.0065;
        csll = subtotal * 0.01;
        cofins = subtotal * 0.03;
        
        if (subtotal > 666.67) {
          irrf = subtotal * 0.015;
          document.getElementById('irrfItem').style.display = 'flex';
        } else {
          document.getElementById('irrfItem').style.display = 'none';
        }
        
        document.getElementById('impostosContainer').style.display = 'block';
      } else {
        document.getElementById('impostosContainer').style.display = 'none';
      }
      
      const totalDescontos = pis + csll + irrf + cofins;
      const liquido = subtotal - totalDescontos;
      const data = new Date().toLocaleString('pt-BR');
      
      dadosCalculo = {
        profissional,
        formaPagamento: document.getElementById('formaPagamento').value,
        itens: [...itens],
        subtotal,
        pis, csll, irrf, cofins,
        totalDescontos,
        liquido,
        data
      };
      
      document.getElementById('infoNome').textContent = profissional.nome;
      document.getElementById('infoCpf').textContent = profissional.documento;
      document.getElementById('infoTipo').textContent = profissional.regime === 'funcionario' ? 'Funcionário' : 'PJ';
      document.getElementById('infoData').textContent = data;
      document.getElementById('valorSubtotal').textContent = `R$ ${subtotal.toFixed(2)}`;
      document.getElementById('pis').textContent = `R$ ${pis.toFixed(2)}`;
      document.getElementById('csll').textContent = `R$ ${csll.toFixed(2)}`;
      document.getElementById('cofins').textContent = `R$ ${cofins.toFixed(2)}`;
      document.getElementById('irrf').textContent = `R$ ${irrf.toFixed(2)}`;
      document.getElementById('liquido').textContent = `R$ ${liquido.toFixed(2)}`;
      
      document.getElementById('resultado').style.display = 'block';
      document.getElementById('semResultado').style.display = 'none';
    }

    function limparCalculo() {
      itens = [];
      renderizarItens();
      document.getElementById('resultado').style.display = 'none';
      document.getElementById('semResultado').style.display = 'block';
      dadosCalculo = null;
    }

    // ==================== FUNÇÃO DO RECIBO (igual ao original) ====================
    function gerarRecibo() {
      if (!dadosCalculo) {
        alert('Calcule primeiro');
        return;
      }
      
      const d = dadosCalculo;
      const formaPagamentoTexto = {
        pix: 'PIX',
        dinheiro: 'Dinheiro',
        transferencia: 'Transferência Bancária'
      }[d.formaPagamento] || d.formaPagamento;
      
      const dataObj = new Date();
      const dataFormatada = dataObj.toLocaleDateString('pt-BR') + ' ' + 
                            dataObj.toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'});
      
      let linhasTabela = '';
      d.itens.forEach(item => {
        linhasTabela += `
          <tr>
            <td class="col-qtd">${item.qtd}</td>
            <td>${item.descricao || '—'}</td>
            <td class="col-valor">R$ ${item.valorUnitario.toFixed(2)}</td>
            <td class="col-valorpago valor-pago-destaque">R$ ${item.valorTotal.toFixed(2)}</td>
          </tr>
        `;
      });
      
      const reciboHTML = `
        <!DOCTYPE html>
        <html>
        <head>
          <meta charset="UTF-8">
          <title>Recibo de Pagamento</title>
          <style>
            @page { size: A4; margin: 25mm 30mm; }
            body {
              font-family: Arial, sans-serif;
              margin: 0;
              padding: 0;
              background: white;
              color: black;
            }
            .recibo { width: 100%; }
            .titulo { text-align: center; font-size: 26pt; font-weight: 400; margin: 0 0 6mm 0; }
            .linha { border: none; border-top: 1px solid #000; margin: 0 0 8mm 0; }
            .grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 8mm; font-size: 10pt; line-height: 1.4; }
            .direita { text-align: right; }
            .label-negrito { font-weight: 700; }
            .spacer-6 { height: 6mm; }
            .spacer-8 { height: 8mm; }
            table { width: 100%; border-collapse: collapse; font-size: 10pt; }
            th, td { border: 1px solid #000; padding: 3mm; vertical-align: middle; }
            th { text-align: center; font-weight: 700; }
            col.qtd { width: 10%; }
            col.item { width: 55%; }
            col.valor { width: 15%; }
            col.valorPago { width: 20%; }
            .col-qtd { text-align: center; }
            .col-valor, .col-valorpago { text-align: right; }
            .valor-pago-destaque { font-weight: 700; }
            .pago-a { font-size: 10pt; line-height: 1.5; }
          </style>
        </head>
        <body>
          <div class="recibo">
            <h1 class="titulo">Recibo de Pagamento</h1>
            <hr class="linha" />

            <div class="grid2">
              <div>
                <div class="label-negrito">Amor Saúde Pirituba</div>
                <div>Endereço: Avenida Doutor Felipe Pinel</div>
                <div>Bairro: Pirituba / Cidade/Estado: São Paulo/SP</div>
                <div>Data/Hora: ${dataFormatada} - Pagamento: ${formaPagamentoTexto}</div>
              </div>
              <div class="direita">
                <div>Usuário: ${usuario || 'Sistema'}</div>
              </div>
            </div>

            <div class="spacer-6"></div>

            <div class="pago-a">
              Pago a: <span class="label-negrito">${d.profissional.nome}</span> /
              CPF/CNPJ: <span class="label-negrito">${d.profissional.documento}</span>
            </div>

            <div class="spacer-8"></div>

            <table>
              <colgroup>
                <col class="qtd" />
                <col class="item" />
                <col class="valor" />
                <col class="valorPago" />
              </colgroup>
              <thead>
                <tr>
                  <th>Qtd</th>
                  <th>Item</th>
                  <th>Valor Unit.</th>
                  <th>Valor Pago</th>
                </tr>
              </thead>
              <tbody>
                ${linhasTabela}
              </tbody>
            </table>

            ${d.profissional.regime === 'pj-presumido' ? `
            <div style="margin-top: 8mm; font-size: 10pt;">
              <p><strong>Retenções (PJ Presumido):</strong></p>
              <p>PIS: R$ ${d.pis.toFixed(2)} | CSLL: R$ ${d.csll.toFixed(2)} | COFINS: R$ ${d.cofins.toFixed(2)} ${d.irrf > 0 ? `| IRRF: R$ ${d.irrf.toFixed(2)}` : ''}</p>
              <p><strong>Total Líquido: R$ ${d.liquido.toFixed(2)}</strong></p>
            </div>
            ` : `
            <div style="margin-top: 8mm; font-size: 10pt;">
              <p><strong>Total Líquido: R$ ${d.liquido.toFixed(2)}</strong></p>
            </div>
            `}

            <div style="margin-top: 12mm; text-align: center;">
              <div style="border-top: 1px solid #000; width: 50%; margin: 0 auto;"></div>
              <p style="font-size: 10pt;">Assinatura do Responsável</p>
            </div>
          </div>
        </body>
        </html>
      `;
      
      const w = window.open('', '_blank');
      w.document.write(reciboHTML);
      w.document.close();
    }

    // Inicialização
    document.addEventListener('DOMContentLoaded', function() {
      adicionarItem(); // começa com um item
    });
  </script>
</body>
</html>